name: CI Build ELF (manual)

on:
  workflow_dispatch:
    inputs:
      target:
        description: Bazel target to build
        type: string
        default: //examples:coralnpu_v2_hello_world_add_floats.elf
      threads:
        description: Verilator threads (passed via --define VERILATOR_THREADS)
        type: string
        default: "1"

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Bazelisk as bazel
        shell: bash
        run: |
          set -euxo pipefail
          BZLISK_VER=v1.19.0
          curl -sSL -o bazelisk \
            https://github.com/bazelbuild/bazelisk/releases/download/${BZLISK_VER}/bazelisk-linux-amd64
          chmod +x bazelisk
          sudo mv bazelisk /usr/local/bin/bazel
          bazel --version || true

      - name: Install system packages
        shell: bash
        run: |
          set -euxo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends srecord
          sudo rm -rf /var/lib/apt/lists/*

      - name: Env check (STRICT optional)
        env:
          STRICT: "0"
        shell: bash
        run: |
          set -euxo pipefail
          chmod +x scripts/env_check.sh || true
          bash scripts/env_check.sh

      - name: Build ELF
        shell: bash
        run: |
          set -euxo pipefail
          TARGET="${{ inputs.target }}"
          THREADS_FLAG=""
          if [[ "${{ inputs.threads }}" != "1" && -n "${{ inputs.threads }}" ]]; then
            THREADS_FLAG="--define VERILATOR_THREADS=${{ inputs.threads }}"
          fi
          bazel build ${THREADS_FLAG} "$TARGET" --color=yes --curses=no
